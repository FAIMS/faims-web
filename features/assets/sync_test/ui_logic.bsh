createUser(id, firstname, lastname) {
	user = new User(id, firstname, lastname);
	return user;
}

toUsersList(users) {
	users_array = new ArrayList();
	for (User user : users) {
		ua = new ArrayList();
		ua.add(user.getUserId());
		ua.add(user.getFirstName() + " " + user.getLastName());
		users_array.add(ua);
	}
	return users_array;
}

getDefaultUsersList() {
	users = new ArrayList();
	users.add(createUser("1", "Test", "User 1"));
	users.add(createUser("2", "Test", "User 2"));
	users.add(createUser("3", "Test", "User 3"));
	users.add(createUser("4", "Test", "User 4"));
	users.add(createUser("5", "Test", "User 5"));
	return users;
}

usersList = getDefaultUsersList();

populateListForUsers(){
	populateList("user/tab1/users", toUsersList(usersList));
}

login(){
	User user = (User) usersList.get(Integer.parseInt(getListItemValue())-1);
	
	setUser(user);
	showTabGroup("menu");
}

populateListForUsers();

onEvent("user/tab1/users", "click", "login()");

createOption(id, name) {
	ArrayList option = new ArrayList();
	option.add(id);
	option.add(name);
	return option;
}

options = new ArrayList();
options.add(createOption("entity", "Create Entity"));
options.add(createOption("relationship", "Create Relationship"));
options.add(createOption("controls", "Controls"));

populateList("menu/tab1/options", options);

onClickOption() {
	String value = getListItemValue();
	if ("entity".equals(value)) {
		showTabGroup("tabgroup1");
	} else if ("relationship".equals(value)) {
		showTabGroup("tabgroup2");
	} else {
		showTabGroup("tabgroup3");
	}
}

onEvent("menu/tab1/options", "click", "onClickOption()");

setSyncMinInterval(10.0f);
setSyncMaxInterval(20.0f);
setSyncDelay(5.0f);

startSync() {
	setSyncEnabled(true);
	setFileSyncEnabled(true);
}

stopSync() {
	setSyncEnabled(false);
}

syncStarted() {
	//showToast("starting sync");
}

syncCompleted() {
	//showToast("completed sync");
	updateAll();
}

syncFailed() {
	//showToast("failed sync");
}

onSyncEvent("syncStarted()", "syncCompleted()", "syncFailed()");

Object locations = fetchAll("select vocabid, vocabname from vocabulary left join attributekey using (attributeid) where attributename = 'location';");

String entity_id;

saveEntity() {
	
	entity_id = updateEntity(null);
	
}

loadEntity() {

	entity_id = getFieldValue("tabgroup1/tab2/entities");
	
	if (entity_id == null || "".equals(entity_id)) return;
	
	showTab("tabgroup1/tab1", entity_id);
	
}

updateEntity(entity_id) {
	if (entity_id == null || "".equals(entity_id)) entity_id = null;

	List attributes = createAttributeList();
	attributes.add(createEntityAttribute("name", getFieldValue("tabgroup1/tab1/name"), null, null, getFieldCertainty("tabgroup1/tab1/name")));
	attributes.add(createEntityAttribute("value", getFieldAnnotation("tabgroup1/tab1/value"), null, getFieldValue("tabgroup1/tab1/value"), getFieldCertainty("tabgroup1/tab1/value")));
	attributes.add(createEntityAttribute("timestamp", getFieldValue("tabgroup1/tab1/timestamp"), null, null, null));
	Object values = getFieldValue("tabgroup1/tab1/location");
	
	for (Object value : values) {
		attributes.add(createEntityAttribute("location", getFieldAnnotation("tabgroup1/tab1/location"), value.getName(), null, getFieldCertainty("tabgroup1/tab1/location")));
	}
	
	if (!"".equals(getFieldValue("tabgroup1/tab1/file"))) {
		sync = getFieldValue("tabgroup1/tab1/sync");
		filename = attachFile(getLastSelectedFilepath(), "1".equals(sync));
		attributes.add(createEntityAttribute("filename", filename, null, null, null));
	}
	
	if (!"".equals(getFieldValue("tabgroup1/tab1/file2"))) {
		sync = getFieldValue("tabgroup1/tab1/sync");
		filename2 = attachFile(getLastSelectedFilepath(), "1".equals(sync));
		attributes.add(createEntityAttribute("filename2", filename2, null, null, null));
	}
	
	String id = saveArchEnt(entity_id, "small", null, attributes);
	
	updateAll();
	
	return id;
}

clearEntity() {
	newTab("tabgroup1/tab1");
	
	populateCheckBoxGroup("tabgroup1/tab1/location", locations);
	
	setFieldValue("tabgroup1/tab1/timestamp", getCurrentTime());
}

updateAll() {
	Object entities = fetchAll("select uuid, uuid from archentity where uuid || aenttimestamp in ( select uuid || max(aenttimestamp) from archentity group by uuid having deleted is null);");
	
	populateDropDown("tabgroup1/tab2/entities", entities);
}

onEvent("tabgroup1/tab1/save", "click", "saveEntity()");
onEvent("tabgroup1/tab1/clear", "click", "clearEntity()");
onEvent("tabgroup1/tab2/load", "click", "loadEntity()");
onEvent("tabgroup1/tab1/update", "click", "updateEntity(getFieldValue(\"tabgroup1/tab2/entities\"))");

setFilename() {
	setFieldValue("tabgroup1/tab1/file", getLastSelectedFilename());
}

attachFile() {
	showFileBrowser("setFilename()");
}

setFilename1() {
	setFieldValue("tabgroup1/tab1/file2", getLastSelectedFilename());
}

attachFile1() {
	showFileBrowser("setFilename1()");
}

setFilename2() {
	setFieldValue("tabgroup2/tab1/file", getLastSelectedFilename());
}

attachFile2() {
	showFileBrowser("setFilename2()");
}

setFilename3() {
	setFieldValue("tabgroup2/tab1/file2", getLastSelectedFilename());
}

attachFile3() {
	showFileBrowser("setFilename3()");
}

onEvent("tabgroup1/tab1/attach", "click", "attachFile()");
onEvent("tabgroup1/tab1/attach2", "click", "attachFile1()");
onEvent("tabgroup2/tab1/attach", "click", "attachFile2()");
onEvent("tabgroup2/tab1/attach2", "click", "attachFile3()");

initEntity() {
	clearEntity();
}

String rel_id;

saveRel() {
	
	rel_id = updateRel(null);
	
}

loadRel() {

	rel_id = getFieldValue("tabgroup2/tab2/relationships");
	
	if (rel_id == null || "".equals(rel_id)) return;
	
	showTab("tabgroup2/tab1", rel_id);
	
}

updateRel(rel_id) {
	if (rel_id == null || "".equals(rel_id)) rel_id = null;

	List attributes = createAttributeList();
	attributes.add(createRelationshipAttribute("name", getFieldValue("tabgroup2/tab1/name"), null, getFieldCertainty("tabgroup2/tab1/name")));
	Object values = getFieldValue("tabgroup2/tab1/location");
	
	for (Object value : values) {
		attributes.add(createRelationshipAttribute("location", getFieldAnnotation("tabgroup2/tab1/location"), value.getName(), getFieldCertainty("tabgroup2/tab1/location")));
	}
	
	if (!"".equals(getFieldValue("tabgroup2/tab1/file"))) {
		sync = getFieldValue("tabgroup2/tab1/sync");
		filename = attachFile(getLastSelectedFilepath(), "1".equals(sync));
		attributes.add(createRelationshipAttribute("filename", filename, null, null));
	}
	
	if (!"".equals(getFieldValue("tabgroup2/tab1/file2"))) {
		sync = getFieldValue("tabgroup2/tab1/sync");
		filename2 = attachFile(getLastSelectedFilepath(), "1".equals(sync));
		attributes.add(createRelationshipAttribute("filename2", filename2, null, null));
	}
	
	String id = saveRel(rel_id, "abovebelow", null, attributes);
	
	updateAll();
	
	return id;
}

clearRel() {
	newTab("tabgroup2/tab1");
	
	populateCheckBoxGroup("tabgroup2/tab1/location", locations);
}

updateAll() {
	Object entities = fetchAll("select uuid, uuid from archentity where uuid || aenttimestamp in ( select uuid || max(aenttimestamp) from archentity group by uuid having deleted is null);");
	Object relationships = fetchAll("select relationshipid, relationshipid from relationship where relationshipid || relntimestamp in ( select relationshipid || max(relntimestamp) from relationship group by relationshipid having deleted is null);");
	
	populateDropDown("tabgroup1/tab2/entities", entities);
	populateDropDown("tabgroup2/tab2/relationships", relationships);
}

onEvent("tabgroup2/tab1/save", "click", "saveRel()");
onEvent("tabgroup2/tab1/clear", "click", "clearRel()");
onEvent("tabgroup2/tab2/load", "click", "loadRel()");
onEvent("tabgroup2/tab1/update", "click", "updateRel(getFieldValue(\"tabgroup2/tab2/relationships\"))");

initRel() {
	clearRel();
}

init() {
    updateAll();
	startSync();
}

cleanup() {
	stopSync();
}

onEvent("menu", "show", "init()"); 
onEvent("user", "show", "cleanup()");	
onEvent("tabgroup1", "show", "initEntity()");	
onEvent("tabgroup2", "show", "initRel()");	

onEvent("tabgroup3/tab1/start", "click", "setFileSyncEnabled(true)");
onEvent("tabgroup3/tab1/stop", "click", "setFileSyncEnabled(false)");

setFieldValue("tabgroup1/tab1/sync", "0");